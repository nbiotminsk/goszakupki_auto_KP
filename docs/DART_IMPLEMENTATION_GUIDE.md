# ĞŸĞ¾Ğ»Ğ½Ğ°Ñ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ°Ñ†Ğ¸Ñ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ° Goszakupki KP Generator

Ğ”Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚ ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ñ‚ Ğ¸ÑÑ‡ĞµÑ€Ğ¿Ñ‹Ğ²Ğ°ÑÑ‰ÑƒÑ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ´Ğ»Ñ Ğ²Ğ¾ÑÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ Ğ°Ğ½Ğ°Ğ»Ğ¾Ğ³Ğ¸Ñ‡Ğ½Ğ¾Ğ³Ğ¾ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ° Ğ½Ğ° ÑĞ·Ñ‹ĞºĞµ Dart.

---

## 1. ĞĞ±Ñ‰ĞµĞµ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ°

### 1.1 ĞĞ°Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹

Ğ¡Ğ¸ÑÑ‚ĞµĞ¼Ğ° Ğ¿Ñ€ĞµĞ´ÑÑ‚Ğ°Ğ²Ğ»ÑĞµÑ‚ ÑĞ¾Ğ±Ğ¾Ğ¹ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ‚Ğ¾Ñ€ ĞºĞ¾Ğ¼Ğ¼ĞµÑ€Ñ‡ĞµÑĞºĞ¸Ñ… Ğ¿Ñ€ĞµĞ´Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğ¹ Ğ´Ğ»Ñ Ğ±ĞµĞ»Ğ¾Ñ€ÑƒÑÑĞºĞ¾Ğ³Ğ¾ Ğ¿Ğ¾Ñ€Ñ‚Ğ°Ğ»Ğ° Ğ³Ğ¾ÑÑƒĞ´Ğ°Ñ€ÑÑ‚Ğ²ĞµĞ½Ğ½Ñ‹Ñ… Ğ·Ğ°ĞºÑƒĞ¿Ğ¾Ğº goszakupki.by. ĞÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ¹ workflow Ğ²ĞºĞ»ÑÑ‡Ğ°ĞµÑ‚:

1. ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ²Ğ²Ğ¾Ğ´Ğ¸Ñ‚ URL ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹ Ğ·Ğ°ĞºÑƒĞ¿ĞºĞ¸
2. Ğ¡Ğ¸ÑÑ‚ĞµĞ¼Ğ° Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ Ğ¸Ğ·Ğ²Ğ»ĞµĞºĞ°ĞµÑ‚ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ ÑĞ¾ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹
3. ĞĞ±Ğ¾Ğ³Ğ°Ñ‰Ğ°ĞµÑ‚ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ñ‡ĞµÑ€ĞµĞ· Ğ½Ğ°Ğ»Ğ¾Ğ³Ğ¾Ğ²Ñ‹Ğ¹ API Ğ‘ĞµĞ»Ğ°Ñ€ÑƒÑĞ¸
4. Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµÑ‚ Ğ¿Ñ€Ğ¾Ñ„ĞµÑÑĞ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ PDF-Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚
5. ĞĞ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑ‚ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚ Ñ‡ĞµÑ€ĞµĞ· Telegram

Ğ¦ĞµĞ»ĞµĞ²Ğ°Ñ Ğ°ÑƒĞ´Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ñ â€” ĞºĞ¾Ğ¼Ğ¿Ğ°Ğ½Ğ¸Ğ¸, ÑƒÑ‡Ğ°ÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ğµ Ğ² Ğ³Ğ¾ÑÑƒĞ´Ğ°Ñ€ÑÑ‚Ğ²ĞµĞ½Ğ½Ñ‹Ñ… Ğ·Ğ°ĞºÑƒĞ¿ĞºĞ°Ñ… Ğ‘ĞµĞ»Ğ°Ñ€ÑƒÑĞ¸ Ğ¸ Ñ€ĞµĞ³ÑƒĞ»ÑÑ€Ğ½Ğ¾ Ğ¿Ğ¾Ğ´Ğ°ÑÑ‰Ğ¸Ğµ ĞºĞ¾Ğ¼Ğ¼ĞµÑ€Ñ‡ĞµÑĞºĞ¸Ğµ Ğ¿Ñ€ĞµĞ´Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ.

### 1.2 Ğ¢ĞµÑ…Ğ½Ğ¾Ğ»Ğ¾Ğ³Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¹ ÑÑ‚ĞµĞº

**Ğ¡ĞµÑ€Ğ²ĞµÑ€Ğ½Ğ°Ñ Ñ‡Ğ°ÑÑ‚ÑŒ:**
- Node.js 18-22
- Express.js 4.18+
- Puppeteer 24.x (Ğ±Ñ€Ğ°ÑƒĞ·ĞµÑ€Ğ½Ğ°Ñ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ)

**Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ¾Ğ²:**
- Handlebars 4.7 (ÑˆĞ°Ğ±Ğ»Ğ¾Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ)
- Puppeteer print-to-PDF (ĞºĞ¾Ğ½Ğ²ĞµÑ€Ñ‚Ğ°Ñ†Ğ¸Ñ HTML Ğ² PDF)

**Ğ˜Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ğ¸Ğ¸:**
- Telegram Bot API (node-telegram-bot-api)
- ĞĞ°Ğ»Ğ¾Ğ³Ğ¾Ğ²Ñ‹Ğ¹ API Ğ‘ĞµĞ»Ğ°Ñ€ÑƒÑĞ¸ (grp.nalog.gov.by)

**ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ:**
- dotenv 17.x (Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ)

### 1.3 Ğ¡Ñ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ° Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ°

```
goszakupki_auto_KP/
â”œâ”€â”€ server.js              # Ğ“Ğ»Ğ°Ğ²Ğ½Ñ‹Ğ¹ Ñ„Ğ°Ğ¹Ğ» Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ
â”œâ”€â”€ parser.js              # ĞœĞ¾Ğ´ÑƒĞ»ÑŒ Ğ¿Ğ°Ñ€ÑĞ¸Ğ½Ğ³Ğ° ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†
â”œâ”€â”€ pdfGenerator.js        # ĞœĞ¾Ğ´ÑƒĞ»ÑŒ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸ PDF
â”œâ”€â”€ telegramSender.js       # ĞœĞ¾Ğ´ÑƒĞ»ÑŒ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸ Ğ² Telegram
â”œâ”€â”€ calculator-template.html # Ğ¨Ğ°Ğ±Ğ»Ğ¾Ğ½ ĞºĞ¾Ğ¼Ğ¼ĞµÑ€Ñ‡ĞµÑĞºĞ¾Ğ³Ğ¾ Ğ¿Ñ€ĞµĞ´Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ
â”œâ”€â”€ package.json           # Ğ—Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ npm
â”œâ”€â”€ .env                   # ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ (Ğ½Ğµ Ğ² Ñ€ĞµĞ¿Ğ¾Ğ·Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ¸)
â”œâ”€â”€ data/
â”‚   â””â”€â”€ catalog.json       # ĞšĞ°Ñ‚Ğ°Ğ»Ğ¾Ğ³ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ¾Ğ² Ğ´Ğ»Ñ Ğ°Ğ²Ñ‚Ğ¾Ğ´Ğ¾Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ñ
â”œâ”€â”€ generated/             # Ğ¡Ğ³ĞµĞ½ĞµÑ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğµ PDF Ñ„Ğ°Ğ¹Ğ»Ñ‹
â”œâ”€â”€ public/                # Ğ¡Ñ‚Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğµ Ñ„Ğ°Ğ¹Ğ»Ñ‹
â”œâ”€â”€ images/                # Ğ˜Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ (Ğ»Ğ¾Ğ³Ğ¾Ñ‚Ğ¸Ğ¿, Ğ¿ĞµÑ‡Ğ°Ñ‚ÑŒ)
â””â”€â”€ test/
    â””â”€â”€ telegram_test.js   # Ğ¢ĞµÑÑ‚ Telegram
```

---

## 2. Ğ”ĞµÑ‚Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ Ğ¼Ğ¾Ğ´ÑƒĞ»ĞµĞ¹

### 2.1 ĞœĞ¾Ğ´ÑƒĞ»ÑŒ parser.js

#### 2.1.1 ĞšĞ»Ğ°ÑÑ GoszakupkiParser

Ğ¦ĞµĞ½Ñ‚Ñ€Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ ĞºĞ»Ğ°ÑÑ Ğ´Ğ»Ñ Ğ¿Ğ°Ñ€ÑĞ¸Ğ½Ğ³Ğ° ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ† Ğ¿Ğ¾Ñ€Ñ‚Ğ°Ğ»Ğ° Ğ³Ğ¾ÑĞ·Ğ°ĞºÑƒĞ¿Ğ¾Ğº.

```javascript
class GoszakupkiParser {
    constructor() {
        // Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ñ ÑĞµĞ»ĞµĞºÑ‚Ğ¾Ñ€Ğ°Ğ¼Ğ¸ Ğ¸Ğ· selectors.json
    }
    
    async parsePage(url) {
        // ĞÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ¹ Ğ¼ĞµÑ‚Ğ¾Ğ´ Ğ¿Ğ°Ñ€ÑĞ¸Ğ½Ğ³Ğ° ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹
        // Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ Ğ¾Ğ±ÑŠĞµĞºÑ‚ Ñ Ğ¸Ğ·Ğ²Ğ»ĞµÑ‡ĞµĞ½Ğ½Ñ‹Ğ¼Ğ¸ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¼Ğ¸
    }
    
    async getCompanyDataFromAPI(unp) {
        // Ğ—Ğ°Ğ¿Ñ€Ğ¾Ñ Ğº Ğ½Ğ°Ğ»Ğ¾Ğ³Ğ¾Ğ²Ğ¾Ğ¼Ñƒ API Ğ‘ĞµĞ»Ğ°Ñ€ÑƒÑĞ¸
    }
    
    async checkNetworkConnectivity() {
        // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚Ğ¸ ÑĞµÑ‚Ğ¸
    }
}
```

#### 2.1.2 ĞœĞµÑ‚Ğ¾Ğ´ parsePage(url)

**ĞĞ»Ğ³Ğ¾Ñ€Ğ¸Ñ‚Ğ¼ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹:**

1. Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ½Ğ¾Ğ²Ğ¾Ğ¹ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹ Ğ² Puppeteer
2. ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° user-agent Ğ¸ viewport
3. ĞŸĞµÑ€ĞµÑ…Ğ¾Ğ´ Ğ¿Ğ¾ URL Ñ retry-Ğ»Ğ¾Ğ³Ğ¸ĞºĞ¾Ğ¹
4. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ½Ğ° Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸ ÑĞµÑ‚Ğ¸
5. Ğ˜Ğ·Ğ²Ğ»ĞµÑ‡ĞµĞ½Ğ¸Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¸Ğ· Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ† ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹
6. Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ ÑĞºÑ€Ğ¸Ğ½ÑˆĞ¾Ñ‚Ğ° Ğ¿Ñ€Ğ¸ Ğ¾ÑˆĞ¸Ğ±ĞºĞ°Ñ…

**ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ Puppeteer Ğ´Ğ»Ñ Ğ¿Ğ°Ñ€ÑĞ¸Ğ½Ğ³Ğ°:**

```javascript
{
    viewport: { width: 1920, height: 1080 },
    headers: {
        'Accept': 'text/html,application/xhtml+xml',
        'Accept-Language': 'ru,en;q=0.9',
        'Accept-Encoding': 'gzip, deflate',
        'DNT': '1',
        'Connection': 'keep-alive',
        'Upgrade-Insecure-Requests': '1'
    },
    timeout: 60000,
    waitUntil: 'domcontentloaded'
}
```

**Retry-Ğ»Ğ¾Ğ³Ğ¸ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¾ÑˆĞ¸Ğ±ĞºĞ°Ñ… ÑĞµÑ‚Ğ¸:**
- ĞœĞ°ĞºÑĞ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ¿Ğ¾Ğ¿Ñ‹Ñ‚Ğ¾Ğº: 5
- Ğ—Ğ°Ğ´ĞµÑ€Ğ¶ĞºĞ° Ğ¼ĞµĞ¶Ğ´Ñƒ Ğ¿Ğ¾Ğ¿Ñ‹Ñ‚ĞºĞ°Ğ¼Ğ¸: 5000ms
- ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ñ‚Ğ¸Ğ¿Ğ° Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸ (Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ¸ĞµĞ½Ñ‚Ğ½Ñ‹Ğµ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸ = Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€, ĞºÑ€Ğ¸Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğµ = Ğ¾ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ°)

#### 2.1.3 Ğ˜Ğ·Ğ²Ğ»ĞµĞºĞ°ĞµĞ¼Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¸Ğ· ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹

**ĞÑĞ½Ğ¾Ğ²Ğ½Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ ĞºĞ¾Ğ¼Ğ¿Ğ°Ğ½Ğ¸Ğ¸-Ğ·Ğ°ĞºĞ°Ğ·Ñ‡Ğ¸ĞºĞ°:**

```typescript
interface CustomerData {
    companyName: string;       // ĞŸĞ¾Ğ»Ğ½Ğ¾Ğµ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¾Ñ€Ğ³Ğ°Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸
    shortName: string;         // ĞšÑ€Ğ°Ñ‚ĞºĞ¾Ğµ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ
    unp: string;              // Ğ£Ñ‡ĞµÑ‚Ğ½Ñ‹Ğ¹ Ğ½Ğ¾Ğ¼ĞµÑ€ Ğ¿Ğ»Ğ°Ñ‚ĞµĞ»ÑŒÑ‰Ğ¸ĞºĞ° (9 Ñ†Ğ¸Ñ„Ñ€)
    address: string;           // Ğ®Ñ€Ğ¸Ğ´Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¹ Ğ°Ğ´Ñ€ĞµÑ
    status: string;            // Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ (Ğ´ĞµĞ¹ÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ğ¹/Ğ»Ğ¸ĞºĞ²Ğ¸Ğ´Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½)
    registrationDate: string;  // Ğ”Ğ°Ñ‚Ğ° Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ğ¸
}
```

**Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¾ Ğ·Ğ°ĞºÑƒĞ¿ĞºĞµ:**

```typescript
interface ProcurementData {
    // Ğ›Ğ¾Ñ‚ 1
    lotDescription: string;    // ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ Ğ»Ğ¾Ñ‚Ğ°
    lotCount: number;          // ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾
    lotUnit: string;           // Ğ•Ğ´Ğ¸Ğ½Ğ¸Ñ†Ğ° Ğ¸Ğ·Ğ¼ĞµÑ€ĞµĞ½Ğ¸Ñ (ÑˆÑ‚, ĞºĞ³, ÑƒÑĞ»ÑƒĞ³Ğ° Ğ¸ Ñ‚.Ğ´.)
    
    // Ğ›Ğ¾Ñ‚ 2 (Ğ¾Ğ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾)
    hasSecondLot: boolean;
    lotDescription2: string;
    lotCount2: number;
    lotUnit2: string;
    
    // Ğ£ÑĞ»Ğ¾Ğ²Ğ¸Ñ Ğ·Ğ°ĞºÑƒĞ¿ĞºĞ¸
    place: string;             // ĞœĞµÑÑ‚Ğ¾ Ğ¿Ğ¾ÑÑ‚Ğ°Ğ²ĞºĞ¸
    payment: string;           // ĞŸĞ¾Ñ€ÑĞ´Ğ¾Ğº Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ñ‹
    endDate: string;           // Ğ¡Ñ€Ğ¾Ğº Ğ¿Ğ¾Ğ´Ğ°Ñ‡Ğ¸ Ğ¿Ñ€ĞµĞ´Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğ¹
    date: string;              // Ğ”Ğ°Ñ‚Ğ° Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ°
    
    // Ğ¢ĞµÑ…Ğ½Ğ¸Ñ‡ĞµÑĞºĞ°Ñ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ
    pageType: 'marketing' | 'tender' | 'request' | 'contract' | 'single-source';
    debugInfo?: object;
}
```

#### 2.1.4 Ğ›Ğ¾Ğ³Ğ¸ĞºĞ° Ğ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸Ñ Ñ‚Ğ¸Ğ¿Ğ° ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹

```javascript
const pageTypeDetectors = {
    marketing: /\/marketing\/view\//,
    tender: /\/tender\/view\//,
    request: /\/request\/view\//,
    contract: /\/contract\/view\//,
    'single-source': /\/single-source\/view\//
};
```

#### 2.1.5 ĞĞ»Ğ³Ğ¾Ñ€Ğ¸Ñ‚Ğ¼ Ğ¸Ğ·Ğ²Ğ»ĞµÑ‡ĞµĞ½Ğ¸Ñ UNP (ÑƒÑ‡ĞµÑ‚Ğ½Ñ‹Ğ¹ Ğ½Ğ¾Ğ¼ĞµÑ€)

ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ°: UNP Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ±Ñ‹Ñ‚ÑŒ Ğ¿ĞµÑ€ĞµĞ¿ÑƒÑ‚Ğ°Ğ½ Ñ Ğ½Ğ¾Ğ¼ĞµÑ€Ğ¾Ğ¼ Ğ·Ğ°ĞºÑƒĞ¿ĞºĞ¸.

**Ğ ĞµÑˆĞµĞ½Ğ¸Ğµ:** ĞœĞ½Ğ¾Ğ¶ĞµÑÑ‚Ğ²ĞµĞ½Ğ½Ğ°Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ñ ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ¼:

```javascript
// 1. ĞŸĞ¾Ğ¸ÑĞº Ğ² "Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ğ¾Ğ¹" Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ğµ (Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ° Ñ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¼Ğ¸ Ğ¾Ñ€Ğ³Ğ°Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸)
const correctTableTds = findCorrectTableTds(page);

// 2. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ½Ğ° Ğ¸ÑĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ
const excludePatterns = [
    /Ğ¿Ñ€ĞµĞ´Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸[ÑÑ]/i,          // "Ğ¿Ñ€ĞµĞ´Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ" Ğ² Ñ‚ĞµĞºÑÑ‚Ğµ
    /^01$/,                     // Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ Ñ†Ğ¸Ñ„Ñ€Ñ‹ "01"
    /^[0-9]{1,2}\/[0-9]{2,4}$/  // ĞĞ¾Ğ¼ĞµÑ€ Ğ·Ğ°ĞºÑƒĞ¿ĞºĞ¸ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ° "01/2024"
];

// 3. Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ: 9 Ñ†Ğ¸Ñ„Ñ€, Ğ½Ğµ Ğ²Ñ…Ğ¾Ğ´Ğ¸Ñ‚ Ğ² exclude-ÑĞ¿Ğ¸ÑĞ¾Ğº
const unpPattern = /^[0-9]{9}$/;
```

#### 2.1.6 ĞœĞµÑ‚Ğ¾Ğ´ getCompanyDataFromAPI(unp)

**Ğ—Ğ°Ğ¿Ñ€Ğ¾Ñ Ğº Ğ½Ğ°Ğ»Ğ¾Ğ³Ğ¾Ğ²Ğ¾Ğ¼Ñƒ API Ğ‘ĞµĞ»Ğ°Ñ€ÑƒÑĞ¸:**

```
URL: https://grp.nalog.gov.by/api/nice/public/api/v1/unp/{unp}
Method: GET
Headers:
    Accept: application/json
    Accept-Encoding: gzip, deflate
    Connection: keep-alive
    User-Agent: (Ğ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµÑ‚ÑÑ Ğ´Ğ¸Ğ½Ğ°Ğ¼Ğ¸Ñ‡ĞµÑĞºĞ¸)
```

**Retry-Ğ»Ğ¾Ğ³Ğ¸ĞºĞ° Ñ ÑĞºÑĞ¿Ğ¾Ğ½ĞµĞ½Ñ†Ğ¸Ğ°Ğ»ÑŒĞ½Ğ¾Ğ¹ Ğ·Ğ°Ğ´ĞµÑ€Ğ¶ĞºĞ¾Ğ¹:**

```javascript
const maxAttempts = 5;
const baseDelayMs = 20000;  // 20 ÑĞµĞºÑƒĞ½Ğ´
const jitter = Math.random() * 1000;  // Ğ¡Ğ»ÑƒÑ‡Ğ°Ğ¹Ğ½Ñ‹Ğ¹ Ğ´Ğ¶Ğ¸Ñ‚Ñ‚ĞµÑ€

// Ğ¤Ğ¾Ñ€Ğ¼ÑƒĞ»Ğ° Ğ·Ğ°Ğ´ĞµÑ€Ğ¶ĞºĞ¸: baseDelay * 2^attempt + jitter
const attemptDelay = baseDelayMs * Math.pow(2, attempt) + jitter;
```

**Ğ¢Ğ¸Ğ¿Ğ¸Ñ‡Ğ½Ñ‹Ğµ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸ API:**

```typescript
interface ApiError {
    code: number;      // ĞšĞ¾Ğ´ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸
    message: string;  // Ğ¡Ğ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ¾Ğ± Ğ¾ÑˆĞ¸Ğ±ĞºĞµ
    isTransient: boolean;  // ĞœĞ¾Ğ¶Ğ½Ğ¾ Ğ»Ğ¸ Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ñ‚ÑŒ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ
}

// ĞŸÑ€Ğ¸Ğ¼ĞµÑ€Ñ‹:
- 404: Ğ£ĞĞŸ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½
- 429: ĞŸÑ€ĞµĞ²Ñ‹ÑˆĞµĞ½ Ğ»Ğ¸Ğ¼Ğ¸Ñ‚ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ² (Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ¸ĞµĞ½Ñ‚Ğ½Ğ°Ñ)
- 500: Ğ’Ğ½ÑƒÑ‚Ñ€ĞµĞ½Ğ½ÑÑ Ğ¾ÑˆĞ¸Ğ±ĞºĞ° ÑĞµÑ€Ğ²ĞµÑ€Ğ° (Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ¸ĞµĞ½Ñ‚Ğ½Ğ°Ñ)
- ECONNRESET: Ğ¡Ğ±Ñ€Ğ¾Ñ ÑĞ¾ĞµĞ´Ğ¸Ğ½ĞµĞ½Ğ¸Ñ (Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ¸ĞµĞ½Ñ‚Ğ½Ğ°Ñ)
```

**ĞĞ³ĞµĞ½Ñ‚ Ñ keep-alive Ğ´Ğ»Ñ HTTPS:**

```javascript
const agent = new https.Agent({
    keepAlive: true,
    keepAliveMsecs: 30000,
    maxSockets: 5,
    rejectUnauthorized: false  // Ğ”Ğ»Ñ Ğ¾Ğ±Ñ…Ğ¾Ğ´Ğ° Ğ½ĞµĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ñ… SSL-Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼
});
```

**Ğ£ÑĞ¿ĞµÑˆĞ½Ñ‹Ğ¹ Ğ¾Ñ‚Ğ²ĞµÑ‚ API:**

```typescript
interface NiceApiResponse {
    unp: "193896074";
    fullName: "ĞĞ±Ñ‰ĞµÑÑ‚Ğ²Ğ¾ Ñ Ğ¾Ğ³Ñ€Ğ°Ğ½Ğ¸Ñ‡ĞµĞ½Ğ½Ğ¾Ğ¹ Ğ¾Ñ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²ĞµĞ½Ğ½Ğ¾ÑÑ‚ÑŒÑ \"Ğ¥Ğ•Ğ¡Ğ¡Ğ•Ğ -ĞŸĞ›Ğ®Ğ¡\"";
    shortName: "ĞĞĞ \"Ğ¥ĞµÑÑĞµÑ€-ĞŸĞ»ÑÑ\"";
    address: "220045, Ğ³.ĞœĞ¸Ğ½ÑĞº, ÑƒĞ». ĞšĞ°Ğ»ÑŒĞ²Ğ°Ñ€Ğ¸Ğ¹ÑĞºĞ°Ñ, Ğ´. 25, Ğ¿Ğ¾Ğ¼. 420";
    registrationDate: "2023-04-20";
    taxOfficeCode: "110";
    taxOfficeName: "Ğ˜Ğ½ÑĞ¿ĞµĞºÑ†Ğ¸Ñ ĞœĞĞ¡ Ğ¿Ğ¾ ĞŸĞµÑ€Ğ²Ğ¾Ğ¼Ğ°Ğ¹ÑĞºĞ¾Ğ¼Ñƒ Ñ€Ğ°Ğ¹Ğ¾Ğ½Ñƒ Ğ³.ĞœĞ¸Ğ½ÑĞºĞ°";
    statusCode: "1";
    statusName: "Ğ”ĞµĞ¹ÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ğ¹";
    statusChangeDate: null;
}
```

**Ğ˜Ğ·Ğ²ĞµÑÑ‚Ğ½Ñ‹Ğµ Ğ¸ÑĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ:**
- UNP `101223447` Ğ·Ğ°Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½ ĞºĞ°Ğº Ñ‚ĞµÑÑ‚Ğ¾Ğ²Ñ‹Ğ¹ Ğ¸ Ğ¸ÑĞºĞ»ÑÑ‡Ğ°ĞµÑ‚ÑÑ Ğ¸Ğ· Ğ¿Ğ°Ñ€ÑĞ¸Ğ½Ğ³Ğ°

---

### 2.2 ĞœĞ¾Ğ´ÑƒĞ»ÑŒ pdfGenerator.js

#### 2.2.1 ĞšĞ»Ğ°ÑÑ PDFGenerator

```javascript
class PDFGenerator {
    constructor() {
        this.templatePath = path.join(__dirname, 'calculator-template.html');
        this.generatedDir = path.join(__dirname, 'generated');
    }
    
    async generatePDF(data, options) {
        // ĞÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ¹ Ğ¼ĞµÑ‚Ğ¾Ğ´ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸ PDF
    }
    
    async generatePDFFromURL(url, extraData) {
        // Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ PDF Ğ¸Ğ· URL Ñ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¼ Ğ¿Ğ°Ñ€ÑĞ¸Ğ½Ğ³Ğ¾Ğ¼
    }
}
```

#### 2.2.2 ĞŸĞ¾Ğ´Ğ³Ğ¾Ñ‚Ğ¾Ğ²ĞºĞ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ´Ğ»Ñ ÑˆĞ°Ğ±Ğ»Ğ¾Ğ½Ğ°

```typescript
interface TemplateData {
    // Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ ĞºĞ¾Ğ¼Ğ¿Ğ°Ğ½Ğ¸Ğ¸-Ğ¸ÑĞ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»Ñ
    LOGO_PATH: string;      // Base64 Ğ¸Ğ»Ğ¸ Ğ¿ÑƒÑ‚ÑŒ Ğº Ğ»Ğ¾Ğ³Ğ¾Ñ‚Ğ¸Ğ¿Ñƒ
    PECHAT_PATH: string;    // Base64 Ğ¸Ğ»Ğ¸ Ğ¿ÑƒÑ‚ÑŒ Ğº Ğ¿ĞµÑ‡Ğ°Ñ‚Ğ¸
    
    // Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ·Ğ°ĞºĞ°Ğ·Ñ‡Ğ¸ĞºĞ°
    COMPANY_NAME: string;
    UNP: string;
    ADDRESS: string;
    
    // ĞœĞµÑ‚Ğ°Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ°
    DATE: string;          // Ğ”Ğ°Ñ‚Ğ° Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸ (Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚ Ğ”Ğ”.ĞœĞœ.Ğ“Ğ“Ğ“Ğ“)
    
    // Ğ£ÑĞ»Ğ¾Ğ²Ğ¸Ñ Ğ·Ğ°ĞºÑƒĞ¿ĞºĞ¸
    PLACE: string;
    PAYMENT: string;
    END_DATE: string;
    FREE_DESCRIPTION?: string;
    
    // Ğ›Ğ¾Ñ‚ 1 (ÑÑ‚Ğ°Ñ€Ñ‹Ğ¹ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚ - Ğ¾Ğ´Ğ½Ğ° Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ñ)
    lot_description?: string;
    lot_count?: number;
    lot_unit?: string;
    unit_price?: number;
    total_amount?: number;
    
    // Ğ›Ğ¾Ñ‚ 1 (Ğ½Ğ¾Ğ²Ñ‹Ğ¹ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚ - Ğ¼Ğ°ÑÑĞ¸Ğ² Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ğ¹)
    lot_1_items?: LotItem[];
    has_first_lot?: boolean;
    
    // Ğ›Ğ¾Ñ‚ 2 (ÑÑ‚Ğ°Ñ€Ñ‹Ğ¹ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚)
    lot_description_2?: string;
    lot_count_2?: number;
    lot_unit_2?: string;
    unit_price_2?: number;
    total_amount_2?: number;
    lot_number_2?: number;
    
    // Ğ›Ğ¾Ñ‚ 2 (Ğ½Ğ¾Ğ²Ñ‹Ğ¹ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚)
    lot_2_items?: LotItem[];
    has_second_lot?: boolean;
    
    // Ğ˜Ñ‚Ğ¾Ğ³Ğ¸
    total_summary_amount?: number;
    
    // Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¸Ğ· API
    API_DATA?: object;
}

interface LotItem {
    name: string;
    quantity: number;
    unit: string;
    price: number;
}
```

#### 2.2.3 Ğ’ÑĞ¿Ğ¾Ğ¼Ğ¾Ğ³Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğµ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¸ Handlebars

```javascript
Handlebars.registerHelper('formatNumber', function(value) {
    // Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ñ‡Ğ¸ÑĞ»Ğ° Ñ Ñ€Ğ°Ğ·Ğ´ĞµĞ»Ğ¸Ñ‚ĞµĞ»ÑĞ¼Ğ¸ Ğ¿Ñ€Ğ¾Ğ±ĞµĞ»Ğ¾Ğ²
    // 10000.50 â†’ "10 000,50"
    return value.toLocaleString('ru-RU', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    });
});

Handlebars.registerHelper('multiply', function(a, b) {
    return a * b;
});

Handlebers.registerHelper('increment', function(index) {
    return index + 1;
});
```

#### 2.2.4 ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ¸Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ğ¹

**Ğ›Ğ¾Ğ³Ğ¾Ñ‚Ğ¸Ğ¿ Ğ¸ Ğ¿ĞµÑ‡Ğ°Ñ‚ÑŒ ĞºĞ¾Ğ½Ğ²ĞµÑ€Ñ‚Ğ¸Ñ€ÑƒÑÑ‚ÑÑ Ğ² Base64:**

```javascript
class PDFGenerator {
    imageToBase64(imagePath) {
        const candidates = [
            imagePath,
            path.join(__dirname, '..', 'images', imagePath),
            path.join(process.cwd(), imagePath),
            path.join(process.cwd(), 'images', imagePath)
        ];
        
        for (const candidate of candidates) {
            if (fs.existsSync(candidate)) {
                return fs.readFileSync(candidate, 'base64');
            }
        }
        return null;
    }
}
```

#### 2.2.5 Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ PDF Ñ‡ĞµÑ€ĞµĞ· Puppeteer

```javascript
async generatePDF(templateData) {
    // 1. ĞšĞ¾Ğ¼Ğ¿Ğ¸Ğ»ÑÑ†Ğ¸Ñ ÑˆĞ°Ğ±Ğ»Ğ¾Ğ½Ğ° Handlebars
    const htmlContent = Handlebars.compile(templateSource)(templateData);
    
    // 2. Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ ÑƒĞ½Ğ¸ĞºĞ°Ğ»ÑŒĞ½Ğ¾Ğ³Ğ¾ Ğ¸Ğ¼ĞµĞ½Ğ¸ Ñ„Ğ°Ğ¹Ğ»Ğ°
    const timestamp = new Date();
    const fileName = `KP_${companyName}_${year}${month}${day}_${hours}${minutes}${seconds}.pdf`;
    
    // 3. ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ Puppeteer Ğ´Ğ»Ñ Ğ¿ĞµÑ‡Ğ°Ñ‚Ğ¸
    const browserOptions = {
        headless: process.env.HEADLESS !== 'false',
        args: [
            '--no-sandbox',
            '--disable-setuid-sandbox',
            '--disable-dev-shm-usage',
            '--disable-gpu',
            '--window-size=1920,1080'
        ]
    };
    
    // 4. ĞŸĞ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ñ‹ Ğ¿ĞµÑ‡Ğ°Ñ‚Ğ¸ PDF
    const pdfOptions = {
        path: outputPath,
        format: 'A4',
        printBackground: true,
        margin: {
            top: '15mm',
            right: '15mm',
            bottom: '15mm',
            left: '15mm'
        },
        displayHeaderFooter: false,
        preferCSSPageSize: true
    };
    
    // 5. ĞŸĞµÑ‡Ğ°Ñ‚ÑŒ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹ Ğ² PDF
    await page.setContent(htmlContent, { waitUntil: 'networkidle0' });
    await page.pdf(pdfOptions);
}
```

#### 2.2.6 Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚ Ğ¸Ğ¼ĞµĞ½Ğ¸ Ñ„Ğ°Ğ¹Ğ»Ğ°

```
KP_{companyName}_{YYYYMMDD}_{HHmmss}.pdf

ĞŸÑ€Ğ¸Ğ¼ĞµÑ€:
KP_ĞĞĞ_ĞœĞ¸Ğ½ÑĞºĞ²Ğ¾Ğ´Ğ¾ĞºĞ°Ğ½Ğ°Ğ»_20240115_143052.pdf
```

---

### 2.3 ĞœĞ¾Ğ´ÑƒĞ»ÑŒ server.js

#### 2.3.1 Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ±Ñ€Ğ°ÑƒĞ·ĞµÑ€Ğ°

```javascript
let browserInstance = null;

async function initializeBrowser() {
    const headless = process.env.HEADLESS !== 'false';
    
    const launchOptions = {
        headless: headless,
        args: [
            '--no-sandbox',
            '--disable-setuid-sandbox',
            '--disable-dev-shm-usage',
            '--disable-gpu',
            '--window-size=1920,1080',
            '--hide-scrollbars',
            '--disable-notifications',
            '--disable-extensions',
            '--mute-audio'
        ]
    };
    
    if (!headless) {
        // Ğ”Ğ»Ñ Ñ€Ğ°Ğ·Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸: Ğ½Ğµ ÑĞºÑ€Ñ‹Ğ²Ğ°Ñ‚ÑŒ Ğ¾ĞºĞ½Ğ¾ Ğ±Ñ€Ğ°ÑƒĞ·ĞµÑ€Ğ°
        delete launchOptions.args;
    }
    
    browserInstance = await puppeteer.launch(launchOptions);
}

async function ensureBrowser() {
    if (!browserInstance || !browserInstance.isConnected()) {
        await initializeBrowser();
    }
}
```

#### 2.3.2 API Endpoints

**POST /generate**

Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ PDF Ğ¸Ğ· URL ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹ Ğ·Ğ°ĞºÑƒĞ¿ĞºĞ¸.

```http
POST /generate
Content-Type: application/json

{
    "url": "https://goszakupki.by/marketing/view/12345",
    "unitPrice": 1500.00,        // Ğ¦ĞµĞ½Ğ° Ğ·Ğ° ĞµĞ´Ğ¸Ğ½Ğ¸Ñ†Ñƒ Ğ»Ğ¾Ñ‚Ğ° 1
    "unitPrice2": null,           // Ğ¦ĞµĞ½Ğ° Ğ·Ğ° ĞµĞ´Ğ¸Ğ½Ğ¸Ñ†Ñƒ Ğ»Ğ¾Ñ‚Ğ° 2 (Ğ¾Ğ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾)
    "includeLot1": true,         // Ğ’ĞºĞ»ÑÑ‡Ğ¸Ñ‚ÑŒ Ğ»Ğ¾Ñ‚ 1 Ğ² ĞšĞŸ
    "includeLot2": false,        // Ğ’ĞºĞ»ÑÑ‡Ğ¸Ñ‚ÑŒ Ğ»Ğ¾Ñ‚ 2 Ğ² ĞšĞŸ
    "freeDescription": "",       // Ğ”Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾Ğµ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ
    "unit1": "ÑƒÑĞ»ÑƒĞ³Ğ°",           // Ğ•Ğ´Ğ¸Ğ½Ğ¸Ñ†Ğ° Ğ¸Ğ·Ğ¼ĞµÑ€ĞµĞ½Ğ¸Ñ Ğ»Ğ¾Ñ‚Ğ° 1
    "unit2": null                // Ğ•Ğ´Ğ¸Ğ½Ğ¸Ñ†Ğ° Ğ¸Ğ·Ğ¼ĞµÑ€ĞµĞ½Ğ¸Ñ Ğ»Ğ¾Ñ‚Ğ° 2
}
```

**ĞÑ‚Ğ²ĞµÑ‚:**

```json
{
    "success": true,
    "fileName": "KP_company_20240115_143052.pdf",
    "filePath": "/path/to/generated/KP_company_20240115_143052.pdf",
    "url": "https://goszakupki.by/marketing/view/12345",
    "companyShortName": "ĞĞĞ ĞšĞ¾Ğ¼Ğ¿Ğ°Ğ½Ğ¸Ñ",
    "proposalEndDate": "2024-01-20"
}
```

---

**POST /api/generate-manual**

Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ PDF Ñ Ñ€ÑƒÑ‡Ğ½Ñ‹Ğ¼ Ğ²Ğ²Ğ¾Ğ´Ğ¾Ğ¼ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… (Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ° ĞºĞ°Ñ‚Ğ°Ğ»Ğ¾Ğ³Ğ° Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ¾Ğ²).

```http
POST /api/generate-manual
Content-Type: application/json

{
    "customerName": "ĞĞĞ ĞœĞ¸Ğ½ÑĞºĞ²Ğ¾Ğ´Ğ¾ĞºĞ°Ğ½Ğ°Ğ»",
    "customerUnp": "193896074",
    "customerAddress": "Ğ³. ĞœĞ¸Ğ½ÑĞº, ÑƒĞ». ĞŸÑ€Ğ¸Ğ¼ĞµÑ€Ğ½Ğ°Ñ, Ğ´. 1",
    "skipUnpApi": false,         // ĞŸÑ€Ğ¾Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ Ğº Ğ½Ğ°Ğ»Ğ¾Ğ³Ğ¾Ğ²Ğ¾Ğ¼Ñƒ API
    "includeLot1": true,
    "includeLot2": false,
    
    // ĞœĞ°ÑÑĞ¸Ğ² Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ğ¹ Ğ»Ğ¾Ñ‚Ğ° 1 (Ğ½Ğ¾Ğ²Ñ‹Ğ¹ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚)
    "lot1Items": [
        {"name": "Ğ¢Ğ¾Ğ²Ğ°Ñ€ 1", "quantity": 10, "price": 150.00, "unit": "ÑˆÑ‚"},
        {"name": "Ğ¢Ğ¾Ğ²Ğ°Ñ€ 2", "quantity": 5, "price": 300.00, "unit": "ĞºĞ¾Ğ¼Ğ¿Ğ»"}
    ],
    
    // ĞœĞ°ÑÑĞ¸Ğ² Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ğ¹ Ğ»Ğ¾Ñ‚Ğ° 2 (Ğ¾Ğ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾)
    "lot2Items": [],
    
    "freeDescription": "Ğ“Ğ°Ñ€Ğ°Ğ½Ñ‚Ğ¸Ñ 24 Ğ¼ĞµÑÑÑ†Ğ°",
    "place": "Ğ³. ĞœĞ¸Ğ½ÑĞº, ÑĞºĞ»Ğ°Ğ´ Ğ¿Ğ¾ Ğ°Ğ´Ñ€ĞµÑÑƒ...",
    "payment": "100% Ğ¿Ñ€ĞµĞ´Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ğ° Ğ² Ñ‚ĞµÑ‡ĞµĞ½Ğ¸Ğµ 5 Ğ´Ğ½ĞµĞ¹",
    "endDate": "2024-01-20"
}
```

---

**POST /api/save-catalog**

Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ ĞºĞ°Ñ‚Ğ°Ğ»Ğ¾Ğ³Ğ° Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ¾Ğ² Ğ´Ğ»Ñ Ğ°Ğ²Ñ‚Ğ¾Ğ´Ğ¾Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ñ.

```http
POST /api/save-catalog
Content-Type: application/json

{
    "items": [
        {"name": "Ğ¢Ğ¾Ğ²Ğ°Ñ€ 1", "quantity": 10, "price": 150.00, "unit": "ÑˆÑ‚"},
        {"name": "Ğ¢Ğ¾Ğ²Ğ°Ñ€ 2", "quantity": 5, "price": 300.00, "unit": "ĞºĞ¾Ğ¼Ğ¿Ğ»"}
    ]
}
```

**ĞÑ‚Ğ²ĞµÑ‚:**

```json
{
    "success": true,
    "message": "ĞšĞ°Ñ‚Ğ°Ğ»Ğ¾Ğ³ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½ Ğ² data/catalog.json"
}
```

---

**GET /api/company/:unp**

ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… ĞºĞ¾Ğ¼Ğ¿Ğ°Ğ½Ğ¸Ğ¸ Ğ¸Ğ· Ğ½Ğ°Ğ»Ğ¾Ğ³Ğ¾Ğ²Ğ¾Ğ³Ğ¾ API.

```http
GET /api/company/193896074
```

**ĞÑ‚Ğ²ĞµÑ‚:**

```json
{
    "success": true,
    "data": {
        "unp": "193896074",
        "fullName": "ĞĞ±Ñ‰ĞµÑÑ‚Ğ²Ğ¾ Ñ Ğ¾Ğ³Ñ€Ğ°Ğ½Ğ¸Ñ‡ĞµĞ½Ğ½Ğ¾Ğ¹ Ğ¾Ñ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²ĞµĞ½Ğ½Ğ¾ÑÑ‚ÑŒÑ \"Ğ¥Ğ•Ğ¡Ğ¡Ğ•Ğ -ĞŸĞ›Ğ®Ğ¡\"",
        "shortName": "ĞĞĞ \"Ğ¥ĞµÑÑĞµÑ€-ĞŸĞ»ÑÑ\"",
        "address": "220045, Ğ³.ĞœĞ¸Ğ½ÑĞº, ÑƒĞ». ĞšĞ°Ğ»ÑŒĞ²Ğ°Ñ€Ğ¸Ğ¹ÑĞºĞ°Ñ, Ğ´. 25, Ğ¿Ğ¾Ğ¼. 420",
        "status": "Ğ”ĞµĞ¹ÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ğ¹",
        "registrationDate": "2023-04-20"
    }
}
```

---

**POST /send-to-telegram**

ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° ÑĞ³ĞµĞ½ĞµÑ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ğ¾Ğ³Ğ¾ PDF Ğ² Telegram.

```http
POST /send-to-telegram
Content-Type: application/json

{
    "fileName": "KP_company_20240115_143052.pdf",
    "chatId": "-1001234567890",  // ID Ñ‡Ğ°Ñ‚Ğ° (Ğ¾Ñ‚Ñ€Ğ¸Ñ†Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğ¹ Ğ´Ğ»Ñ ÑÑƒĞ¿ĞµÑ€Ğ³Ñ€ÑƒĞ¿Ğ¿)
    "caption": "ĞšĞ¾Ğ¼Ğ¼ĞµÑ€Ñ‡ĞµÑĞºĞ¾Ğµ Ğ¿Ñ€ĞµĞ´Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ Ğ´Ğ»Ñ ĞĞĞ ĞœĞ¸Ğ½ÑĞºĞ²Ğ¾Ğ´Ğ¾ĞºĞ°Ğ½Ğ°Ğ»",
    "proposalEndDate": "2024-01-20",
    "companyShortName": "ĞĞĞ ĞœĞ¸Ğ½ÑĞºĞ²Ğ¾Ğ´Ğ¾ĞºĞ°Ğ½Ğ°Ğ»"
}
```

**ĞÑ‚Ğ²ĞµÑ‚:**

```json
{
    "success": true,
    "message": "Ğ”Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½ Ğ² Telegram"
}
```

---

**GET /telegram-status**

ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚Ğ¸ Telegram.

```http
GET /telegram-status
```

**ĞÑ‚Ğ²ĞµÑ‚:**

```json
{
    "available": true,
    "botInfo": {
        "id": 123456789,
        "username": "mybot",
        "first_name": "My Bot"
    },
    "message": "Telegram Ğ±Ğ¾Ñ‚ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ĞµĞ½"
}
```

---

**GET /health**

ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ·Ğ´Ğ¾Ñ€Ğ¾Ğ²ÑŒÑ ÑĞµÑ€Ğ²ĞµÑ€Ğ°.

```http
GET /health
```

**ĞÑ‚Ğ²ĞµÑ‚:**

```json
{
    "status": "ok",
    "timestamp": "2024-01-15T14:30:52.000Z",
    "uptime": 3600.5
}
```

#### 2.3.3 Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾Ñ€Ñ‚Ğ°Ğ¼Ğ¸ (Port Fallback)

```javascript
async function startServer() {
    const preferredPort = process.env.PORT || 3001;
    const maxAttempts = 5;
    let selectedPort = null;
    
    for (let attempt = 0; attempt < maxAttempts; attempt++) {
        try {
            selectedPort = preferredPort + attempt;
            await new Promise(resolve => {
                serverInstance = app.listen(selectedPort, '0.0.0.0', resolve);
            });
            console.log(`Server running on port ${selectedPort}`);
            break;
        } catch (error) {
            if (error.code === 'EADDRINUSE') {
                console.log(`Port ${selectedPort} is busy, trying next...`);
                continue;
            }
            throw error;
        }
    }
}
```

#### 2.3.4 ĞÑ‡Ğ¸ÑÑ‚ĞºĞ° ÑÑ‚Ğ°Ñ€Ñ‹Ñ… Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²

```javascript
function cleanupGeneratedFiles() {
    const files = fs.readdirSync(generatedDir);
    const now = Date.now();
    const maxAgeMs = 24 * 60 * 60 * 1000; // 24 Ñ‡Ğ°ÑĞ°
    
    files.forEach(file => {
        const filePath = path.join(generatedDir, file);
        const stats = fs.statSync(filePath);
        
        if (now - stats.mtimeMs > maxAgeMs) {
            fs.unlinkSync(filePath);
        }
    });
}
```

---

### 2.4 ĞœĞ¾Ğ´ÑƒĞ»ÑŒ telegramSender.js

#### 2.4.1 ĞšĞ»Ğ°ÑÑ TelegramSender

```javascript
class TelegramSender {
    constructor(token, chatId) {
        this.bot = new TelegramBot(token, { polling: false });
        this.defaultChatId = chatId;
    }
    
    async sendDocument(filePath, options) {
        const chatId = options.chatId || this.defaultChatId;
        
        await this.bot.sendDocument(chatId, filePath, {
            caption: options.caption,
            parse_mode: 'HTML'
        });
    }
    
    async checkAvailability() {
        try {
            const botInfo = await this.bot.getMe();
            return {
                available: true,
                botInfo: {
                    id: botInfo.id,
                    username: botInfo.username,
                    first_name: botInfo.first_name
                }
            };
        } catch (error) {
            return {
                available: false,
                message: error.message
            };
        }
    }
}
```

#### 2.4.2 Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ

```javascript
function formatMessage(data) {
    return `
ğŸ“„ <b>ĞšĞ¾Ğ¼Ğ¼ĞµÑ€Ñ‡ĞµÑĞºĞ¾Ğµ Ğ¿Ñ€ĞµĞ´Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ</b>

ğŸ¢ ĞšĞ¾Ğ¼Ğ¿Ğ°Ğ½Ğ¸Ñ: ${data.companyShortName}
ğŸ“… Ğ¡Ñ€Ğ¾Ğº Ğ¿Ğ¾Ğ´Ğ°Ñ‡Ğ¸: ${data.proposalEndDate}

<i>Ğ¤Ğ°Ğ¹Ğ»: ${data.fileName}</i>
    `.trim();
}
```

---

### 2.5 Ğ¨Ğ°Ğ±Ğ»Ğ¾Ğ½ calculator-template.html

#### 2.5.1 Ğ¡Ñ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ° HTML-ÑˆĞ°Ğ±Ğ»Ğ¾Ğ½Ğ°

```html
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>ĞšĞ¾Ğ¼Ğ¼ĞµÑ€Ñ‡ĞµÑĞºĞ¾Ğµ Ğ¿Ñ€ĞµĞ´Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ</title>
    <style>
        @media print {
            @page {
                size: A4;
                margin: 15mm;
            }
            body {
                margin: 0;
                padding: 0;
            }
        }
        
        body {
            font-family: "Times New Roman", Times, serif;
            font-size: 12pt;
            line-height: 1.5;
            color: #000;
            background: #fff;
            max-width: 210mm;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        
        .header-table td {
            vertical-align: top;
        }
        
        .company-details {
            text-align: left;
            font-size: 10pt;
            line-height: 1.3;
        }
        
        .price-table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
            font-size: 10pt;
        }
        
        .price-table th,
        .price-table td {
            border: 1px solid #000;
            padding: 4px 6px;
            text-align: left;
        }
        
        .price-table th {
            background: #f0f0f0;
            font-weight: bold;
        }
        
        .footer-info {
            margin-top: 0px;
            font-weight: bold;
        }
        
        .signature-table {
            width: 100%;
            margin-top: 40px;
            border-collapse: collapse;
        }
    </style>
</head>
<body>
    <!-- Ğ¨Ğ°Ğ¿ĞºĞ° Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ° -->
    <table class="header-table">
        <tr>
            <td style="width: 20%; vertical-align: top">
                <img src="{{LOGO_PATH}}" alt="Hesser Group Logo" style="max-width: 150px;"/>
            </td>
            <td style="width: 50%; vertical-align: top; text-align: left; font-size: 10pt;">
                <strong>ĞĞĞ "Ğ¥ĞµÑÑĞµÑ€-ĞŸĞ»ÑÑ"</strong><br/>
                Ğ£ĞĞŸ 193896074<br/>
                Ğ -Ñ BY76 ALFA... Ğ² Ğ—ĞĞ "ĞĞ»ÑŒÑ„Ğ°-Ğ±Ğ°Ğ½Ğº"<br/>
                Ğ®Ñ€. Ğ°Ğ´Ñ€ĞµÑ: 220045, Ğ³. ĞœĞ¸Ğ½ÑĞº, ÑƒĞ». ĞšĞ°Ğ»ÑŒĞ²Ğ°Ñ€Ğ¸Ğ¹ÑĞºĞ°Ñ, Ğ´. 25, Ğ¿Ğ¾Ğ¼. 420<br/>
                Ñ‚ĞµĞ». +375 (29) 252-49-88 - Meter.by
            </td>
            <td style="width: 30%; vertical-align: top; padding-left: 15px; border-left: 1px solid #ccc; font-size: 10pt;">
                <strong>Ğ—Ğ°ĞºĞ°Ğ·Ñ‡Ğ¸Ğº:</strong><br/>
                {{COMPANY_NAME}}<br/>
                Ğ£ĞĞŸ: {{UNP}}<br/>
                {{ADDRESS}}
            </td>
        </tr>
    </table>
    
    <div class="doc-number">Ğ˜ÑÑ…. â„– ___ Ğ¾Ñ‚ {{DATE}}</div>
    
    <h2>Ğ¦ĞµĞ½Ğ¾Ğ²Ğ¾Ğµ Ğ¿Ñ€ĞµĞ´Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ:</h2>
    
    <!-- Ğ¢Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ° Ñ Ğ»Ğ¾Ñ‚Ğ°Ğ¼Ğ¸ -->
    <table class="price-table">
        <thead>
            <tr>
                <th style="width: 5%">â„– Ğ¿/Ğ¿</th>
                <th style="width: 45%">ĞĞ°Ğ¸Ğ¼ĞµĞ½Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ</th>
                <th style="width: 15%">ĞšĞ¾Ğ»-Ğ²Ğ¾</th>
                <th style="width: 15%">Ğ•Ğ´. Ğ¸Ğ·Ğ¼.</th>
                <th style="width: 10%">Ğ¦ĞµĞ½Ğ° Ğ·Ğ° ĞµĞ´., BYN</th>
                <th style="width: 10%">Ğ¡ÑƒĞ¼Ğ¼Ğ°, BYN</th>
            </tr>
        </thead>
        <tbody>
            {{#if lot_1_items}}
                {{#each lot_1_items}}
                <tr>
                    <td align="center">{{increment @index}}</td>
                    <td>{{name}}</td>
                    <td align="center">{{quantity}}</td>
                    <td align="center">{{unit}}</td>
                    <td align="right">{{formatNumber price}}</td>
                    <td align="right">{{formatNumber (multiply quantity price)}}</td>
                </tr>
                {{/each}}
                <tr style="background: #f5f5f5">
                    <td colspan="5" align="right" style="font-weight: bold">Ğ˜Ñ‚Ğ¾Ğ³Ğ¾:</td>
                    <td align="right" style="font-weight: bold">{{formatNumber total_amount}}</td>
                </tr>
            {{else}}
                {{#if has_first_lot}}
                <tr>
                    <td align="center">1</td>
                    <td>{{lot_description}}</td>
                    <td align="center">{{lot_count}}</td>
                    <td align="center">{{lot_unit}}</td>
                    <td align="right">{{formatNumber unit_price}}</td>
                    <td align="right">{{formatNumber total_amount}}</td>
                </tr>
                {{/if}}
            {{/if}}
            <!-- ĞĞ½Ğ°Ğ»Ğ¾Ğ³Ğ¸Ñ‡Ğ½Ğ¾ Ğ´Ğ»Ñ Ğ»Ğ¾Ñ‚Ğ° 2 -->
        </tbody>
    </table>
    
    <div style="margin: 0px 0; font-size: 10pt; white-space: pre-wrap">
        {{FREE_DESCRIPTION}}
    </div>
    
    <!-- ĞŸĞ¾Ğ´Ğ²Ğ°Ğ» Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ° -->
    <div class="footer-info">
        <p>
            <strong>Ğ˜Ñ‚Ğ¾Ğ³Ğ¾:</strong>
            <span style="font-weight: normal">
                {{#if has_first_lot}}
                    {{#if has_second_lot}}
                        Ğ›Ğ¾Ñ‚ â„–1: {{formatNumber total_amount}}, Ğ›Ğ¾Ñ‚ â„–2: {{formatNumber total_amount_2}}
                    {{else}}
                        {{formatNumber total_summary_amount}}
                    {{/if}}
                {{else}}
                    {{formatNumber total_summary_amount}}
                {{/if}}
                Ğ±ĞµĞ».Ñ€ÑƒĞ±. Ğ±ĞµĞ· ĞĞ”Ğ¡ ÑĞ¾Ğ³Ğ»Ğ°ÑĞ½Ğ¾ Ğ“Ğ»Ğ°Ğ²Ñ‹ 32 Ñ€Ğ°Ğ·Ğ´ĞµĞ»Ğ° 7 Ğ¾ÑĞ¾Ğ±ĞµĞ½Ğ½Ğ¾Ğ¹ Ñ‡Ğ°ÑÑ‚Ğ¸ Ğ½Ğ°Ğ»Ğ¾Ğ³Ğ¾Ğ²Ğ¾Ğ³Ğ¾ ĞºĞ¾Ğ´ĞµĞºÑĞ° Ğ Ğ‘.
            </span>
        </p>
        <hr/>
        <p><strong>Ğ¡Ñ€Ğ¾Ğº Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ñ Ñ€Ğ°Ğ±Ğ¾Ñ‚ (Ğ¿Ğ¾ÑÑ‚Ğ°Ğ²ĞºĞ¸):</strong> <span style="font-weight: normal">{{END_DATE}}</span></p>
        <p><strong>ĞŸĞ¾Ñ€ÑĞ´Ğ¾Ğº Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ñ‹:</strong> <span style="font-weight: normal">{{PAYMENT}}</span></p>
        <p><strong>ĞœĞµÑÑ‚Ğ¾ Ğ¿Ğ¾ÑÑ‚Ğ°Ğ²ĞºĞ¸:</strong> <span style="font-weight: normal">{{PLACE}}</span></p>
    </div>
    
    <div style="margin-top: 40px; display: flex; align-items: center; gap: 15px;">
        <strong>Ğ”Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€</strong>
        <img src="{{PECHAT_PATH}}" alt="ĞŸĞµÑ‡Ğ°Ñ‚ÑŒ" style="max-width: 200px;"/>
        <strong>Ğ•.Ğ’.Ğ“Ñ€ÑƒĞ·Ğ´</strong>
    </div>
</body>
</html>
```

---

## 3. ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ Ğ¸ Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ

### 3.1 Ğ¤Ğ°Ğ¹Ğ» .env

```env
# Ğ¡ĞµÑ€Ğ²ĞµÑ€
PORT=3001

# Puppeteer
HEADLESS=true

# Telegram
TELEGRAM_BOT_TOKEN=your_bot_token_here
TELEGRAM_CHAT_ID=-1001234567890

# ĞĞ°Ğ»Ğ¾Ğ³Ğ¾Ğ²Ñ‹Ğ¹ API
API_UNP_DISABLE=false
API_UNP_TIMEOUT_MS=20000
API_UNP_MAX_ATTEMPTS=5
```

### 3.2 Ğ¡ĞµĞ»ĞµĞºÑ‚Ğ¾Ñ€Ñ‹ (selectors.json)

Ğ¤Ğ°Ğ¹Ğ» `selectors.json` ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ñ‚ CSS-ÑĞµĞ»ĞµĞºÑ‚Ğ¾Ñ€Ñ‹ Ğ´Ğ»Ñ Ğ¿Ğ°Ñ€ÑĞ¸Ğ½Ğ³Ğ° Ñ€Ğ°Ğ·Ğ»Ğ¸Ñ‡Ğ½Ñ‹Ñ… ÑĞ»ĞµĞ¼ĞµĞ½Ñ‚Ğ¾Ğ² ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹. Ğ¡Ñ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ°:

```json
{
    "customerInfo": {
        "table": "table.customer-table",
        "companyName": ".company-name",
        "unp": ".unp-value",
        "address": ".address"
    },
    "lotInfo": {
        "table": ".lot-table",
        "description": ".lot-desc",
        "quantity": ".lot-qty",
        "unit": ".lot-unit"
    },
    "procurementTerms": {
        "place": ".delivery-place",
        "payment": ".payment-terms",
        "endDate": ".submission-deadline"
    }
}
```

---

## 4. ĞŸĞ¾Ñ‚Ğ¾Ğº Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ² ÑĞ¸ÑÑ‚ĞµĞ¼Ğµ

### 4.1 Ğ”Ğ¸Ğ°Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ° Ğ¿Ğ¾Ñ‚Ğ¾ĞºĞ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ĞŸĞĞ›Ğ¬Ğ—ĞĞ’ĞĞ¢Ğ•Ğ›Ğ¬                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         FRONTEND (Ğ±Ñ€Ğ°ÑƒĞ·ĞµÑ€)                              â”‚
â”‚                    https://meter.by/kp-generator                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                         POST /generate (URL + Ñ†ĞµĞ½Ñ‹)
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         EXPRESS SERVER                                  â”‚
â”‚                           server.js                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â–¼                               â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚    Puppeteer Browser    â”‚       â”‚    Telegram Sender     â”‚
    â”‚  (browserInstance)      â”‚       â”‚  telegramSender.js     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚                               â–²
                    â–¼                               â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  GoszakupkiParser       â”‚       â”‚   PDF File             â”‚
    â”‚  parser.js              â”‚       â”‚   (generated/)        â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                     ĞĞ°Ğ»Ğ¾Ğ³Ğ¾Ğ²Ñ‹Ğ¹ API Ğ Ğ‘                             â”‚
    â”‚               https://grp.nalog.gov.by/api/...                   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                     PDFGenerator                                 â”‚
    â”‚                 pdfGenerator.js                                  â”‚
    â”‚    Handlebars Template â”€â”€â–º HTML â”€â”€â–º Puppeteer PDF â”€â”€â–º PDF      â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                      RESPONSE                                    â”‚
    â”‚    { success, fileName, filePath, companyShortName, ... }       â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 Ğ”ĞµÑ‚Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ¿Ğ¾Ñ‚Ğ¾Ğº Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸ PDF

```typescript
async function generateKPFlow(req, res) {
    // 1. Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ Ğ²Ñ…Ğ¾Ğ´Ğ½Ñ‹Ñ… Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
    const { url, unitPrice, includeLot1 } = req.body;
    
    // 2. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ Ğ±Ñ€Ğ°ÑƒĞ·ĞµÑ€Ğ°
    await ensureBrowser();
    
    // 3. ĞŸĞ°Ñ€ÑĞ¸Ğ½Ğ³ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹ Ğ·Ğ°ĞºÑƒĞ¿ĞºĞ¸
    const parser = new GoszakupkiParser();
    const parsedData = await parser.parsePage(url);
    
    // 4. Ğ—Ğ°Ğ¿Ñ€Ğ¾Ñ Ğº Ğ½Ğ°Ğ»Ğ¾Ğ³Ğ¾Ğ²Ğ¾Ğ¼Ñƒ API (ĞµÑĞ»Ğ¸ Ğ½Ğµ Ğ¾Ñ‚ĞºĞ»ÑÑ‡ĞµĞ½Ğ¾)
    let apiData = null;
    if (parsedData.UNP && !process.env.API_UNP_DISABLE) {
        apiData = await parser.getCompanyDataFromAPI(parsedData.UNP);
    }
    
    // 5. ĞŸĞ¾Ğ´Ğ³Ğ¾Ñ‚Ğ¾Ğ²ĞºĞ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ´Ğ»Ñ ÑˆĞ°Ğ±Ğ»Ğ¾Ğ½Ğ°
    const templateData = prepareTemplateData({
        parsedData,
        apiData,
        prices: { unitPrice, unitPrice2 },
        options: { includeLot1, includeLot2 }
    });
    
    // 6. Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ PDF
    const pdfGenerator = new PDFGenerator();
    const result = await pdfGenerator.generatePDF(templateData);
    
    // 7. ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ°
    res.json({
        success: true,
        fileName: result.fileName,
        filePath: result.filePath,
        companyShortName: apiData?.shortName || parsedData.companyName
    });
}
```

---

## 5. Ğ¡Ğ¿ĞµÑ†Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ñ Ğ´Ğ»Ñ Dart-Ñ€ĞµĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸

### 5.1 Ğ ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´ÑƒĞµĞ¼Ñ‹Ğ¹ ÑÑ‚ĞµĞº Ğ´Ğ»Ñ Dart

**Backend:**
- Dart + Shelf / Alfred / Start
- Dart http/http + retry
- html/parser Ğ¸Ğ»Ğ¸ cheeriodart

**Browser Automation:**
- puppeteer-core Ñ Dart FFI
- Ğ˜Ğ»Ğ¸ dart-Ñ‡ĞµÑ€ĞµĞ· Node.js child_process (bridge)

**PDF Generation:**
- dart_pdf / pdf.dart
- Ğ˜Ğ»Ğ¸ Ñ€ĞµĞ½Ğ´ĞµÑ€Ğ¸Ğ½Ğ³ HTML â†’ print to PDF Ñ‡ĞµÑ€ĞµĞ· puppeteer

**Telegram:**
- telegram_bot_api Ğ¸Ğ»Ğ¸ dart_telegram_bot

**API Client:**
- dio Ğ¸Ğ»Ğ¸ http Ñ retry

### 5.2 Ğ¡Ñ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ° Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ° Ğ½Ğ° Dart

```
lib/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ parser/
â”‚   â”‚   â”œâ”€â”€ goszakupki_parser.dart
â”‚   â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â”‚   â”œâ”€â”€ customer_data.dart
â”‚   â”‚   â”‚   â”œâ”€â”€ procurement_data.dart
â”‚   â”‚   â”‚   â””â”€â”€ api_response.dart
â”‚   â”‚   â””â”€â”€ selectors/
â”‚   â”‚       â””â”€â”€ selectors.dart
â”‚   â”‚
â”‚   â”œâ”€â”€ pdf/
â”‚   â”‚   â”œâ”€â”€ pdf_generator.dart
â”‚   â”‚   â””â”€â”€ templates/
â”‚   â”‚       â””â”€â”€ calculator_template.html
â”‚   â”‚
â”‚   â”œâ”€â”€ telegram/
â”‚   â”‚   â””â”€â”€ telegram_sender.dart
â”‚   â”‚
â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â”œâ”€â”€ server.dart
â”‚   â”‚   â””â”€â”€ endpoints/
â”‚   â”‚       â”œâ”€â”€ generate_endpoint.dart
â”‚   â”‚       â”œâ”€â”€ manual_endpoint.dart
â”‚   â”‚       â””â”€â”€ telegram_endpoint.dart
â”‚   â”‚
â”‚   â””â”€â”€ utils/
â”‚       â”œâ”€â”€ browser_manager.dart
â”‚       â”œâ”€â”€ config.dart
â”‚       â””â”€â”€ cleanup_worker.dart
â”‚
â”œâ”€â”€ server.dart
â””â”€â”€ main.dart
```

### 5.3 ĞšĞ»ÑÑ‡ĞµĞ²Ñ‹Ğµ Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… (Dart)

```dart
import 'package:json_annotation/json_annotation.dart';

part 'customer_data.g.dart';

@JsonSerializable()
class CustomerData {
  final String fullName;
  final String? shortName;
  final String unp;
  final String? address;
  final String? status;
  final String? registrationDate;
  
  CustomerData({
    required this.fullName,
    this.shortName,
    required this.unp,
    this.address,
    this.status,
    this.registrationDate,
  });
  
  factory CustomerData.fromJson(Map<String, dynamic> json) =>
      _$CustomerDataFromJson(json);
  Map<String, dynamic> toJson() => _$CustomerDataToJson(this);
}
```

```dart
import 'package:json_annotation/json_annotation.dart';

part 'procurement_data.g.dart';

@JsonSerializable()
class ProcurementData {
  final String url;
  final CustomerData? customer;
  
  // Ğ›Ğ¾Ñ‚ 1
  final String? lotDescription;
  final double? lotCount;
  final String? lotUnit;
  
  // Ğ›Ğ¾Ñ‚ 2
  final bool hasSecondLot;
  final String? lotDescription2;
  final double? lotCount2;
  final String? lotUnit2;
  
  // Ğ£ÑĞ»Ğ¾Ğ²Ğ¸Ñ
  final String? place;
  final String? payment;
  final String? endDate;
  final String date;
  
  // Ğ¢Ğ¸Ğ¿ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹
  final PageType pageType;
  
  ProcurementData({
    required this.url,
    this.customer,
    this.lotDescription,
    this.lotCount,
    this.lotUnit,
    this.hasSecondLot = false,
    this.lotDescription2,
    this.lotCount2,
    this.lotUnit2,
    this.place,
    this.payment,
    required this.endDate,
    required this.date,
    required this.pageType,
  });
  
  factory ProcurementData.fromJson(Map<String, dynamic> json) =>
      _$ProcurementDataFromJson(json);
  Map<String, dynamic> toJson() => _$ProcurementDataToJson(this);
}

enum PageType {
  marketing,
  tender,
  request,
  contract,
  singleSource,
}
```

```dart
import 'package:json_annotation/json_annotation.dart';

part 'lot_item.g.dart';

@JsonSerializable()
class LotItem {
  final String name;
  final double quantity;
  final String unit;
  final double price;
  
  LotItem({
    required this.name,
    required this.quantity,
    required this.unit,
    required this.price,
  });
  
  double get total => quantity * price;
  
  factory LotItem.fromJson(Map<String, dynamic> json) =>
      _$LotItemFromJson(json);
  Map<String, dynamic> toJson() => _$LotItemToJson(this);
}
```

### 5.4 ĞŸÑ€Ğ¸Ğ¼ĞµÑ€ API-ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ° Ñ retry (Dart)

```dart
import 'package:http/http.dart' as http;
import 'dart:convert';

class UnpApiClient {
  static const String baseUrl = 'https://grp.nalog.gov.by/api/nice/public/api/v1';
  final int maxAttempts;
  final Duration timeout;
  
  UnpApiClient({
    this.maxAttempts = 5,
    this.timeout = const Duration(seconds: 20),
  });
  
  Future<CustomerData?> getCompanyData(String unp) async {
    final url = Uri.parse('$baseUrl/unp/$unp');
    
    for (int attempt = 0; attempt < maxAttempts; attempt++) {
      try {
        final response = await http.get(url).timeout(timeout);
        
        if (response.statusCode == 200) {
          final json = jsonDecode(utf8.decode(response.bodyBytes));
          return CustomerData.fromJson(json);
        } else if (response.statusCode == 404) {
          return null; // UNP Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½
        } else if (_isTransientError(response.statusCode)) {
          await _delayBeforeRetry(attempt);
          continue;
        } else {
          throw Exception('API error: ${response.statusCode}');
        }
      } catch (e) {
        if (attempt < maxAttempts - 1) {
          await _delayBeforeRetry(attempt);
          continue;
        }
        rethrow;
      }
    }
    return null;
  }
  
  bool _isTransientError(int statusCode) {
    return statusCode == 429 || 
           statusCode >= 500;
  }
  
  Future<void> _delayBeforeRetry(int attempt) async {
    final baseDelay = Duration(seconds: 20);
    final exponentialDelay = baseDelay * (1 << attempt);
    final jitter = Duration(milliseconds: Random().nextInt(1000));
    await Future.delayed(exponentialDelay + jitter);
  }
}
```

### 5.5 ĞŸÑ€Ğ¸Ğ¼ĞµÑ€ Ğ±Ñ€Ğ°ÑƒĞ·ĞµÑ€-Ğ¼ĞµĞ½ĞµĞ´Ğ¶ĞµÑ€Ğ° (Dart)

```dart
import 'package:puppeteer/puppeteer.dart' as pup;

class BrowserManager {
  pup.Browser? _browser;
  bool headless;
  
  BrowserManager({this.headless = true});
  
  Future<pup.Browser> ensureBrowser() async {
    if (_browser == null || !_browser!.isConnected) {
      await initializeBrowser();
    }
    return _browser!;
  }
  
  Future<pup.Browser> initializeBrowser() async {
    _browser = await pup.puppeteer.launch(
      headless: headless,
      args: [
        '--no-sandbox',
        '--disable-setuid-sandbox',
        '--disable-dev-shm-usage',
        '--disable-gpu',
        '--window-size=1920,1080',
      ],
    );
    return _browser!;
  }
  
  Future<void> closeBrowser() async {
    await _browser?.close();
    _browser = null;
  }
}
```

### 5.6 ĞŸÑ€Ğ¸Ğ¼ĞµÑ€ Ğ¿Ğ°Ñ€ÑĞµÑ€Ğ° ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹ (Dart)

```dart
import 'package:puppeteer/puppeteer.dart' as pup;
import 'package:html/parser.dart' as html_parser;

class GoszakupkiParser {
  final BrowserManager browserManager;
  final UnpApiClient apiClient;
  
  GoszakupkiParser({
    required this.browserManager,
    required this.apiClient,
  });
  
  Future<ProcurementData> parsePage(String url) async {
    final browser = await browserManager.ensureBrowser();
    final page = await browser.newPage();
    
    try {
      // ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° page
      await page.setUserAgent(
        'Mozilla/5.0 (Windows NT 10.0; Win64; x64) '
        'AppleWebKit/537.36 (KHTML, like Gecko) '
        'Chrome/120.0.0.0 Safari/537.36'
      );
      
      await page.setViewport(pup.Viewport(width: 1920, height: 1080));
      
      // ĞŸĞµÑ€ĞµÑ…Ğ¾Ğ´ Ğ¿Ğ¾ URL
      await page.goto(url, waitUntil: pup.NetworkEventType.domcontentloaded);
      
      // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ½Ğ° Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸
      final content = await page.content;
      if (content.contains('error') || content.contains('404')) {
        throw Exception('Failed to load page');
      }
      
      // Ğ˜Ğ·Ğ²Ğ»ĞµÑ‡ĞµĞ½Ğ¸Ğµ HTML
      final html = await page.content;
      final document = html_parser.parse(html);
      
      // ĞŸĞ°Ñ€ÑĞ¸Ğ½Ğ³ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
      final customer = await _parseCustomerData(document);
      final procurementData = await _parseProcurementData(document, url);
      
      // ĞĞ±ÑŠĞµĞ´Ğ¸Ğ½ĞµĞ½Ğ¸Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
      return procurementData.copyWith(customer: customer);
      
    } finally {
      await page.close();
    }
  }
  
  Future<CustomerData?> _parseCustomerData(html_parser.Document document) async {
    // ĞŸĞ¾Ğ¸ÑĞº UNP Ğ² Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ğµ
    final unp = _extractUnp(document);
    
    if (unp == null || unp == '101223447') {
      return null;
    }
    
    // Ğ—Ğ°Ğ¿Ñ€Ğ¾Ñ Ğº API
    return await apiClient.getCompanyData(unp);
  }
  
  String? _extractUnp(html_parser.Document document) {
    // Ğ›Ğ¾Ğ³Ğ¸ĞºĞ° Ğ¿Ğ¾Ğ¸ÑĞºĞ° UNP Ñ Ğ¸ÑĞºĞ»ÑÑ‡ĞµĞ½Ğ¸ĞµĞ¼ Ğ½Ğ¾Ğ¼ĞµÑ€Ğ¾Ğ² Ğ·Ğ°ĞºÑƒĞ¿Ğ¾Ğº
    // ...
    return null;
  }
}
```

---

## 6. Ğ¢ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¸ Ğ¾Ñ‚Ğ»Ğ°Ğ´ĞºĞ°

### 6.1 Ğ¢ĞµÑÑ‚Ğ¾Ğ²Ñ‹Ğ¹ ÑĞºÑ€Ğ¸Ğ¿Ñ‚ Telegram

Ğ¤Ğ°Ğ¹Ğ» `test/telegram_test.js` Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚:
- Ğ”Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚ÑŒ Telegram API
- ĞŸÑ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ Ñ‚Ğ¾ĞºĞµĞ½Ğ° Ğ±Ğ¾Ñ‚Ğ°
- Ğ”Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚ÑŒ Ñ‡Ğ°Ñ‚Ğ°
- Ğ’Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ÑÑ‚ÑŒ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ°

### 6.2 ĞÑ‚Ğ»Ğ°Ğ´Ğ¾Ñ‡Ğ½Ğ°Ñ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ

ĞŸÑ€Ğ¸ Ğ¾ÑˆĞ¸Ğ±ĞºĞ°Ñ… Ğ¿Ğ°Ñ€ÑĞ¸Ğ½Ğ³Ğ° ÑĞ¾Ñ…Ñ€Ğ°Ğ½ÑĞµÑ‚ÑÑ ÑĞºÑ€Ğ¸Ğ½ÑˆĞ¾Ñ‚:
```
error-screenshot-{timestamp}.png
```

Ğ’ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ²ĞºĞ»ÑÑ‡Ğ°ĞµÑ‚ÑÑ `DEBUG_INFO`:
```typescript
interface DebugInfo {
    pageType: string;
    allTdsCount: number;
    relevantTdsCount: number;
    correctTableTdsCount: number;
    companyNameFound: boolean;
    unpFound: boolean;
    addressFound: boolean;
    sampleIrrelevantTds: string[];
}
```

---

## 7. Ğ˜Ğ·Ğ²ĞµÑÑ‚Ğ½Ñ‹Ğµ Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ñ‹ Ğ¸ Ğ¾ÑĞ¾Ğ±ĞµĞ½Ğ½Ğ¾ÑÑ‚Ğ¸

### 7.1 ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ° Ñ UNP

UNP (9 Ñ†Ğ¸Ñ„Ñ€) Ñ‡Ğ°ÑÑ‚Ğ¾ Ğ¿ÑƒÑ‚Ğ°ĞµÑ‚ÑÑ Ñ Ğ½Ğ¾Ğ¼ĞµÑ€Ğ¾Ğ¼ Ğ·Ğ°ĞºÑƒĞ¿ĞºĞ¸. Ğ ĞµÑˆĞµĞ½Ğ¸Ğµ â€” Ğ¼Ğ½Ğ¾Ğ¶ĞµÑÑ‚Ğ²ĞµĞ½Ğ½Ğ°Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚Ğ°.

### 7.2 ĞœĞ½Ğ¾Ğ³Ğ¾ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ‡Ğ½Ñ‹Ğµ Ğ»Ğ¾Ñ‚Ñ‹

Ğ’Ñ‚Ğ¾Ñ€Ğ¾Ğ¹ Ğ»Ğ¾Ñ‚ Ğ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµÑ‚ÑÑ Ğ¿Ğ¾ Ğ½Ğ°Ğ»Ğ¸Ñ‡Ğ¸Ñ `<th class="lot-num">2</th>`.

### 7.3 Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚ Ğ´Ğ°Ñ‚Ñ‹ API

ĞĞ°Ğ»Ğ¾Ğ³Ğ¾Ğ²Ñ‹Ğ¹ API Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ Ğ´Ğ°Ñ‚Ñ‹ Ğ² Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğµ ISO (`2023-04-20`), Ñ‚Ñ€ĞµĞ±ÑƒĞµÑ‚ÑÑ ĞºĞ¾Ğ½Ğ²ĞµÑ€Ñ‚Ğ°Ñ†Ğ¸Ñ Ğ² `DD.MM.YYYY`.

### 7.4 SSL-ÑĞµÑ€Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ‚Ñ‹

ĞĞ°Ğ»Ğ¾Ğ³Ğ¾Ğ²Ñ‹Ğ¹ API Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ñ‚Ñ€ĞµĞ±Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¾Ñ‚ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ `rejectUnauthorized` Ğ² Ğ½ĞµĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ñ… Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸ÑÑ….

### 7.5 Rate Limiting

API Ğ¸Ğ¼ĞµĞµÑ‚ Ğ¾Ğ³Ñ€Ğ°Ğ½Ğ¸Ñ‡ĞµĞ½Ğ¸Ñ â€” Ñ‚Ñ€ĞµĞ±ÑƒĞµÑ‚ÑÑ ÑĞºÑĞ¿Ğ¾Ğ½ĞµĞ½Ñ†Ğ¸Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ğ·Ğ°Ğ´ĞµÑ€Ğ¶ĞºĞ° Ğ¼ĞµĞ¶Ğ´Ñƒ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ°Ğ¼Ğ¸.

---

## 8. Ğ—Ğ°Ğ¿ÑƒÑĞº Ğ¸ Ñ€Ğ°Ğ·Ğ²ĞµÑ€Ñ‚Ñ‹Ğ²Ğ°Ğ½Ğ¸Ğµ

### 8.1 Ğ›Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ·Ğ°Ğ¿ÑƒÑĞº

```bash
# ĞšĞ»Ğ¾Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ñ€ĞµĞ¿Ğ¾Ğ·Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ñ
git clone <repo_url>
cd goszakupki_auto_KP

# Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ĞµĞ¹
npm install

# Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ .env Ñ„Ğ°Ğ¹Ğ»Ğ°
cp .env.example .env
# Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ .env Ñ Ñ€ĞµĞ°Ğ»ÑŒĞ½Ñ‹Ğ¼Ğ¸ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸ÑĞ¼Ğ¸

# Ğ—Ğ°Ğ¿ÑƒÑĞº
npm start
```

### 8.2 Docker

```dockerfile
FROM node:20-alpine

WORKDIR /app
COPY package*.json ./
RUN npm ci --only=production

COPY . .
RUN mkdir -p generated images data

EXPOSE 3001

CMD ["npm", "start"]
```

### 8.3 Railway Deployment

```toml
# railway.toml
[build]
builder = "NIXPACKS"

[deploy]
startCommand = "npm start"
healthcheckPath = "/health"
restartPolicyType = "ON_FAILURE"
restartPolicyMaxRetries = 3
```

---

## 9. Ğ‘ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚ÑŒ Ğ¸ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ´ĞµĞ½Ñ†Ğ¸Ğ°Ğ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ

### 9.1 Ğ¥Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ ÑĞµĞºÑ€ĞµÑ‚Ğ¾Ğ²

- Ğ¢Ğ¾ĞºĞµĞ½ Ğ±Ğ¾Ñ‚Ğ° Telegram
- ID Ñ‡Ğ°Ñ‚Ğ° Telegram
- Ğ’ÑĞµ Ğ² Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ñ… Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ (Ğ½Ğµ Ğ² ĞºĞ¾Ğ´Ğµ)

### 9.2 Ğ’Ñ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ Ñ„Ğ°Ğ¹Ğ»Ñ‹

PDF-Ñ„Ğ°Ğ¹Ğ»Ñ‹ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ ÑƒĞ´Ğ°Ğ»ÑÑÑ‚ÑÑ Ñ‡ĞµÑ€ĞµĞ· 24 Ñ‡Ğ°ÑĞ°.

### 9.3 HTTPS-Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑÑ‹

ĞĞ°Ğ»Ğ¾Ğ³Ğ¾Ğ²Ñ‹Ğ¹ API Ñ‚Ñ€ĞµĞ±ÑƒĞµÑ‚ HTTPS Ñ ĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ñ‹Ğ¼Ğ¸ ÑĞµÑ€Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ‚Ğ°Ğ¼Ğ¸.

---

Ğ­Ñ‚Ğ¾Ñ‚ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚ ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ñ‚ Ğ²ÑÑ Ğ½ĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼ÑƒÑ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ´Ğ»Ñ Ğ²Ğ¾ÑÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ Ğ°Ğ½Ğ°Ğ»Ğ¾Ğ³Ğ¸Ñ‡Ğ½Ğ¾Ğ¹ ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹ Ğ½Ğ° Dart. ĞÑĞ½Ğ¾Ğ²Ğ½Ñ‹Ğµ ÑĞ»Ğ¾Ğ¶Ğ½Ğ¾ÑÑ‚Ğ¸:

1. **Puppeteer integration** â€” Ğ² Dart Ğ½ĞµÑ‚ Ğ½Ğ°Ñ‚Ğ¸Ğ²Ğ½Ğ¾Ğ³Ğ¾ puppeteer, Ğ½ÑƒĞ¶Ğ½Ğ¾ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ puppeteer-core Ñ bridge
2. **HTML-to-PDF** â€” Ğ² Dart Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ dart_pdf Ğ¸Ğ»Ğ¸ Ñ€ĞµĞ½Ğ´ĞµÑ€Ğ¸Ñ‚ÑŒ Ñ‡ĞµÑ€ĞµĞ· headless Chrome
3. **ĞĞ°Ğ»Ğ¾Ğ³Ğ¾Ğ²Ñ‹Ğ¹ API** â€” Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚ ÑÑ‚Ğ°Ğ±Ğ¸Ğ»ÑŒĞ½Ğ¾, Ğ½Ğ¾ Ñ‚Ñ€ĞµĞ±ÑƒĞµÑ‚ retry-Ğ»Ğ¾Ğ³Ğ¸ĞºĞ¸